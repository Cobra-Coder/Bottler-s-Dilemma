<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bottler's Dilemma | OEE Simulation</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase Compat Libraries (Easier for single-file usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#0b0e14',      
                        panel: '#151a23',   
                        surface: '#1e293b', 
                        accent: '#00f0ff',  
                        success: '#00ff94', 
                        danger: '#ff2e54',  
                        warn: '#ffe600',    
                        card: 'rgba(20, 24, 30, 0.8)'
                    },
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flow': 'flow 1s linear infinite',
                        'enter': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        flow: {
                            '0%': { strokeDashoffset: '20' },
                            '100%': { strokeDashoffset: '0' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0b0e14; color: #e2e8f0; overflow: hidden; }
        
        .scada-panel { 
            background: #151a23; 
            border: 1px solid #334155; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        .tech-card { 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .tech-card:hover {
            border-color: var(--accent);
            background: rgba(0, 240, 255, 0.05);
        }
        .tech-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.15);
            background: rgba(0, 240, 255, 0.1);
        }

        .nav-btn { position: relative; overflow: hidden; }
        .nav-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(0, 240, 255, 0.05); }

        .tech-grid {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .input-scada {
            background: #0b0e14;
            border: 1px solid #334155;
            color: white;
            transition: all 0.2s;
        }
        .input-scada:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.2);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0b0e14; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // ==========================================
        // CONFIGURATION FLAG
        // ==========================================
        const USE_FIREBASE = true; // Set to true to enable Firebase
        
        // ==========================================
        // FIREBASE SETUP
        // ==========================================
        // PASTE FIREBASE CONFIG HERE
        const firebaseConfig = {
           	apiKey: "AIzaSyBRODmPlfRCoh3s1uCqTutTftBNaFRfbJ4",
  		authDomain: "oee-tycoon-free.firebaseapp.com",
  		projectId: "oee-tycoon-free",
  		storageBucket: "oee-tycoon-free.firebasestorage.app",
  		messagingSenderId: "301892884988",
  		appId: "1:301892884988:web:2abeddbb5f4b17bb4aba79",
  		measurementId: "G-ELFGFKP7WQ"
        };

        let db = null;
        let auth = null;

        if (USE_FIREBASE && typeof firebase !== 'undefined') {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }

        // ==========================================
        // SOUND ENGINE (UNCHANGED)
        // ==========================================
        const SoundFX = {
            ctx: null,
            init: () => { if (!SoundFX.ctx) SoundFX.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (SoundFX.ctx.state === 'suspended') SoundFX.ctx.resume(); },
            playTone: (f, t, d, v=0.1) => { try { SoundFX.init(); const o=SoundFX.ctx.createOscillator(); const g=SoundFX.ctx.createGain(); o.type=t; o.frequency.setValueAtTime(f,SoundFX.ctx.currentTime); g.gain.setValueAtTime(v,SoundFX.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,SoundFX.ctx.currentTime+d); o.connect(g); g.connect(SoundFX.ctx.destination); o.start(); o.stop(SoundFX.ctx.currentTime+d); } catch(e){} },
            click: () => SoundFX.playTone(1200, 'sine', 0.05, 0.05),
            upgrade: () => { SoundFX.playTone(800, 'sine', 0.1); setTimeout(() => SoundFX.playTone(1200, 'sine', 0.1), 50); },
            downgrade: () => { SoundFX.playTone(600, 'sawtooth', 0.1); setTimeout(() => SoundFX.playTone(300, 'sawtooth', 0.1), 50); },
            commit: () => { SoundFX.playTone(200, 'square', 0.2); setTimeout(() => SoundFX.playTone(100, 'square', 0.4), 100); },
            win: () => [440, 554, 659, 880].forEach((f, i) => setTimeout(() => SoundFX.playTone(f, 'triangle', 0.4), i * 100)),
            start: () => { SoundFX.playTone(400, 'sine', 0.2); setTimeout(() => SoundFX.playTone(800, 'sine', 0.4), 200); },
            urgency: () => {
                const base = 880; const type = 'square';
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 0);
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 200);
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 400);
                setTimeout(() => SoundFX.playTone(base, type, 0.3), 800);
                setTimeout(() => SoundFX.playTone(base, type, 0.3), 1200);
                setTimeout(() => SoundFX.playTone(base, type, 0.3), 1600);
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 2200);
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 2400);
                setTimeout(() => SoundFX.playTone(base, type, 0.1), 2600);
            }
        };

        // ==========================================
        // GAME DATA & LOGIC (UNCHANGED)
        // ==========================================
        const CASE = {
            budget: 50000,
            shiftDuration: 480,
            shiftsPerMonth: 60,
            unitMargin: 0.30,
            costs: { downtime: 150, scrap: 2.50 },
            baseline: { breakdown: 80, setup: 40, speed: 300, stops: 20, rejects: 0.08 }
        };

        const UPGRADES = [
            { id: 'motor', cat: 'Availability', name: "Servo Motor Retrofit", cost: 18000, desc: "Reduces Breakdown Time by 75%", impact: { breakdown: 0.25 }, icon: 'ph-engine' },
            { id: 'pdm', cat: 'Availability', name: "Vibration Sensors (PdM)", cost: 12000, desc: "Reduces Breakdown Time by 40%", impact: { breakdown: 0.6 }, icon: 'ph-wave-sine' },
            { id: 'smed', cat: 'Availability', name: "SMED Blitz Consulting", cost: 5000, desc: "Reduces Setup Time by 50%", impact: { setup: 0.5 }, icon: 'ph-arrows-left-right' },
            { id: 'spares', cat: 'Availability', name: "Spare Parts Kitting", cost: 4000, desc: "Reduces Breakdown Time by 10%", impact: { breakdown: 0.9 }, icon: 'ph-wrench' },
            { id: 'auto_maint', cat: 'Availability', name: "Autonomous Maint.", cost: 8000, desc: "Reduces Breakdown 15%, Setup 10%", impact: { breakdown: 0.85, setup: 0.9 }, icon: 'ph-users-three' },
            { id: 'thermal', cat: 'Availability', name: "Thermography Cam", cost: 6000, desc: "Reduces Breakdown by 12%", impact: { breakdown: 0.88 }, icon: 'ph-thermometer' },
            { id: 'align', cat: 'Availability', name: "Laser Alignment", cost: 3000, desc: "Reduces Setup by 15%", impact: { setup: 0.85 }, icon: 'ph-crosshair' },
            { id: 'quick_change', cat: 'Availability', name: "Quick-Change Tooling", cost: 15000, desc: "Reduces Setup by 70%", impact: { setup: 0.3 }, icon: 'ph-lightning' },
            { id: 'guide', cat: 'Performance', name: "Low-Friction Guides", cost: 15000, desc: "Inc speed to 380 bpm", impact: { speed: 380 }, icon: 'ph-road-horizon' },
            { id: 'dejam', cat: 'Performance', name: "Auto De-Jammer", cost: 8000, desc: "Removes 80% Micro-stops", impact: { stops: 0.2 }, icon: 'ph-robot' },
            { id: 'buffer', cat: 'Performance', name: "Accumulation Buffer", cost: 20000, desc: "Reduces Micro-stop impact 50%", impact: { stops: 0.5 }, icon: 'ph-queue' },
            { id: 'nozzles', cat: 'Performance', name: "High-Speed Nozzles", cost: 25000, desc: "Inc speed to 420 bpm", impact: { speed: 420 }, icon: 'ph-drop-half-bottom' },
            { id: 'hmi', cat: 'Performance', name: "Digital HMI", cost: 6000, desc: "Reduces Stop duration 10%", impact: { stops: 0.9 }, icon: 'ph-monitor' },
            { id: 'inverter', cat: 'Performance', name: "Inverter Drive", cost: 10000, desc: "Inc speed to 350 bpm", impact: { speed: 350 }, icon: 'ph-faders' },
            { id: 'lubrication', cat: 'Performance', name: "Auto-Lubrication", cost: 4000, desc: "Smoother run, -10% stops", impact: { stops: 0.9 }, icon: 'ph-drop' },
            { id: 'cobot', cat: 'Performance', name: "Packaging Cobot", cost: 22000, desc: "Inc speed to 400 bpm", impact: { speed: 400 }, icon: 'ph-android-logo' },
            { id: 'vision', cat: 'Quality', name: "AI Vision System", cost: 14000, desc: "Reduces Reject Rate to 1%", impact: { rejects: 0.01 }, icon: 'ph-eye' },
            { id: 'material', cat: 'Quality', name: "Premium Material", cost: 0, desc: "Rejects -50%, Margin -$0.05", impact: { rejects: 0.5 }, marginHit: 0.05, icon: 'ph-package' },
            { id: 'poka', cat: 'Quality', name: "Poka-Yoke Fixtures", cost: 6000, desc: "Reduces Rejects by 30%", impact: { rejects: 0.7 }, icon: 'ph-shield-check' },
            { id: 'weight', cat: 'Quality', name: "Inline Checkweigher", cost: 10000, desc: "Reduces Rejects by 20%", impact: { rejects: 0.8 }, icon: 'ph-scales' },
            { id: 'temp', cat: 'Quality', name: "Temp Control Unit", cost: 4500, desc: "Reduces Rejects by 15%", impact: { rejects: 0.85 }, icon: 'ph-thermometer' },
            { id: 'xray', cat: 'Quality', name: "X-Ray Inspection", cost: 18000, desc: "Reduces Rejects to 2%", impact: { rejects: 0.02 }, icon: 'ph-bone' },
            { id: 'spc', cat: 'Quality', name: "SPC Software", cost: 5000, desc: "Reduces Rejects by 10%", impact: { rejects: 0.9 }, icon: 'ph-chart-line-up' },
            { id: 'rejector', cat: 'Quality', name: "Auto-Rejector", cost: 7500, desc: "Prevents downstream scrap (-15%)", impact: { rejects: 0.85 }, icon: 'ph-trash' }
        ];

        const calculateStats = (cart) => {
            let stats = { ...CASE.baseline };
            let cost = 0;
            let margin = CASE.unitMargin;

            cart.forEach(id => {
                const upg = UPGRADES.find(u => u.id === id);
                if(!upg) return;
                cost += upg.cost;
                if(upg.marginHit) margin -= upg.marginHit;
                Object.keys(upg.impact).forEach(k => {
                    const val = upg.impact[k];
                    if (k === 'speed' || (k === 'rejects' && val < 0.05 && val > 0)) stats[k] = val; 
                    else stats[k] *= val;
                });
            });

            const availTime = CASE.shiftDuration - stats.breakdown - stats.setup;
            const availPct = availTime / CASE.shiftDuration;
            const speedRatio = stats.speed / 400;
            const microStopLoss = (stats.stops * 2) / CASE.shiftDuration; 
            const perfPct = Math.max(0, speedRatio - microStopLoss);
            const qualPct = 1 - stats.rejects;
            const oee = availPct * perfPct * qualPct;
            
            const netRunTime = availTime - (stats.stops * 2);
            const grossProd = netRunTime * stats.speed;
            const goodUnits = grossProd * qualPct;
            const monthlyProd = goodUnits * CASE.shiftsPerMonth;
            const monthlyProfit = monthlyProd * margin;
            
            const b_avail = 480 - 80 - 40; 
            const b_netRun = b_avail - (20 * 2); 
            const b_gross = b_netRun * 300; 
            const b_good = b_gross * 0.92; 
            const b_totalProd = b_good * CASE.shiftsPerMonth;
            const b_profit = b_totalProd * 0.30;

            const incrementalProfit = monthlyProfit - b_profit;
            const roi = cost > 0 ? (incrementalProfit / cost) * 100 : 0;

            return { oee, profit: monthlyProfit, cost, roi, stats, cart, availPct, perfPct, qualPct, baseProfit: b_profit, totalProd: monthlyProd, baseProd: b_totalProd };
        };

        const solveOptimal = () => {
            let bestCart = [];
            let candidates = [...UPGRADES];
            let currentBudget = CASE.budget;
            let selected = [];
            let changed = true;
            while(changed) {
                changed = false;
                let bestMove = null;
                for(let item of candidates) {
                    if(item.cost <= currentBudget) {
                        const currentRes = calculateStats(selected);
                        const trialRes = calculateStats([...selected, item.id]);
                        if (trialRes.profit > currentRes.profit) {
                            if (!bestMove || (trialRes.profit > calculateStats([...selected, bestMove.id]).profit)) {
                                bestMove = item;
                            }
                        }
                    }
                }
                if(bestMove) {
                    selected.push(bestMove.id);
                    currentBudget -= bestMove.cost;
                    candidates = candidates.filter(i => i.id !== bestMove.id);
                    changed = true;
                }
            }
            return calculateStats(selected);
        };

        // ==========================================
        // BACKEND SERVICES (HYBRID ARCHITECTURE)
        // ==========================================

        const MockAPI = {
            async signIn() {
                // Simulate net lag
                await new Promise(r => setTimeout(r, 500));
                const uid = 'offline-' + Math.floor(Math.random()*10000);
                return { uid, isAnonymous: true };
            },
            async createRoom(hostName, uid) {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const roomData = {
                    code,
                    status: 'waiting',
                    players: [{ uid, name: hostName, isHost: true }],
                    createdAt: Date.now()
                };
                localStorage.setItem(`room:${code}`, JSON.stringify(roomData));
                return code;
            },
            async joinRoom(code, name, uid) {
                const raw = localStorage.getItem(`room:${code}`);
                if (!raw) throw new Error("Room not found");
                const data = JSON.parse(raw);
                if (!data.players.find(p => p.uid === uid)) {
                    data.players.push({ uid, name, isHost: false });
                    localStorage.setItem(`room:${code}`, JSON.stringify(data));
                }
                return data;
            },
            subscribe(code, callback) {
                // Initial call
                const raw = localStorage.getItem(`room:${code}`);
                if(raw) callback(JSON.parse(raw));

                const handler = (e) => {
                    if (e.key === `room:${code}` && e.newValue) {
                        callback(JSON.parse(e.newValue));
                    }
                };
                window.addEventListener('storage', handler);
                // Also poll for local tab changes
                const interval = setInterval(() => {
                    const current = localStorage.getItem(`room:${code}`);
                    if(current) callback(JSON.parse(current));
                }, 1000);
                return () => {
                    window.removeEventListener('storage', handler);
                    clearInterval(interval);
                };
            },
            async submitScore(code, uid, scoreData) {
                const raw = localStorage.getItem(`room:${code}`);
                if (!raw) return;
                const data = JSON.parse(raw);
                const updatedPlayers = data.players.map(p => {
                    if (p.uid === uid) return { ...p, score: scoreData };
                    return p;
                });
                data.players = updatedPlayers;
                const allFinished = updatedPlayers.every(p => p.score);
                if (allFinished) data.status = 'finished';
                localStorage.setItem(`room:${code}`, JSON.stringify(data));
            },
            async updateRoom(code, data) {
                // Merge data
                const raw = localStorage.getItem(`room:${code}`);
                if (!raw) return;
                const current = JSON.parse(raw);
                const updated = { ...current, ...data };
                localStorage.setItem(`room:${code}`, JSON.stringify(updated));
            }
        };

        const FirebaseAPI = {
            async signIn() {
                if (!auth) throw new Error("Firebase not initialized");
                const cred = await auth.signInAnonymously();
                return cred.user;
            },
            async createRoom(hostName, uid) {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                await db.collection('rooms').doc(code).set({
                    code,
                    status: 'waiting',
                    players: [{ uid, name: hostName, isHost: true }],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return code;
            },
            async joinRoom(code, name, uid) {
                const ref = db.collection('rooms').doc(code);
                // Transaction to prevent race conditions on join
                await db.runTransaction(async (t) => {
                    const doc = await t.get(ref);
                    if (!doc.exists) throw new Error("Room not found");
                    const data = doc.data();
                    const players = data.players || [];
                    if (!players.find(p => p.uid === uid)) {
                        players.push({ uid, name, isHost: false });
                        t.update(ref, { players });
                    }
                });
            },
            subscribe(code, callback) {
                return db.collection('rooms').doc(code).onSnapshot(doc => {
                    if (doc.exists) callback(doc.data());
                });
            },
            async updateRoom(code, data) {
                await db.collection('rooms').doc(code).update(data);
            },
            // ROBUST SUBMIT SCORE WITH RETRIES & JITTER
            async submitScore(code, uid, scoreData) {
                const ref = db.collection('rooms').doc(code);
                const maxRetries = 5;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        await db.runTransaction(async (t) => {
                            const doc = await t.get(ref);
                            if (!doc.exists) throw new Error("Room closed");
                            const data = doc.data();
                            const players = data.players || [];
                            
                            // Update player score
                            const updatedPlayers = players.map(p => {
                                if (p.uid === uid) return { ...p, score: scoreData };
                                return p;
                            });

                            const allFinished = updatedPlayers.every(p => p.score);
                            const updatePayload = { players: updatedPlayers };
                            if (allFinished) updatePayload.status = 'finished';

                            t.update(ref, updatePayload);
                        });
                        return; // Success!
                    } catch (e) {
                        console.warn(`Submit attempt ${i+1} failed. Retrying...`, e);
                        if (i === maxRetries - 1) throw e;
                        // Random jitter between 200ms and 1000ms + exponential backoff
                        const jitter = Math.random() * 800 + 200 + (i * 200);
                        await new Promise(r => setTimeout(r, jitter));
                    }
                }
            }
        };

        const Backend = (USE_FIREBASE && db) ? FirebaseAPI : MockAPI;

        // ==========================================
        // REACT COMPONENTS
        // ==========================================

        const FactorySchematic = ({ stats, cart, activeTab, onSelect }) => {
            const isBreakdown = stats.breakdown > 50;
            const isSlow = stats.speed < 350;
            const isScrap = stats.rejects > 0.03;
            
            const getNodeColor = (cat) => {
                if (activeTab === cat) return 'stroke-[#00F0FF] stroke-2 drop-shadow-[0_0_8px_rgba(0,240,255,0.5)]';
                const hasUpgrade = cart.some(id => UPGRADES.find(u => u.id === id).cat === cat);
                return hasUpgrade ? 'stroke-[#00FF94] stroke-2' : 'stroke-slate-600';
            };

            const availVal = ((1 - (stats.breakdown + stats.setup)/480)*100).toFixed(1);
            const perfVal = stats.speed;
            const rejectVal = (stats.rejects * 100).toFixed(1);

            return (
                <div className="w-full h-72 bg-panel rounded-xl relative border border-slate-700 flex items-center justify-center overflow-hidden mb-6 tech-grid shadow-lg">
                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-accent/5 to-transparent opacity-20 pointer-events-none"></div>
                    
                    <svg viewBox="0 0 800 250" className="w-full h-full max-w-5xl cursor-pointer">
                        <path d="M150 120 L650 120" stroke="#334155" strokeWidth="4" />
                        <path d="M150 120 L650 120" stroke="#00F0FF" strokeWidth="2" strokeDasharray="10,10" className="opacity-30 animate-[flow_1s_linear_infinite]" />

                        <g onClick={() => onSelect('Availability')} className="group hover:opacity-90">
                            <rect x="80" y="70" width="140" height="100" rx="10" className={`fill-panel ${getNodeColor('Availability')}`} />
                            <text x="150" y="95" textAnchor="middle" className="fill-slate-400 text-xs font-bold font-mono tracking-widest">AVAILABILITY</text>
                            <text x="150" y="125" textAnchor="middle" className={`text-2xl font-bold font-mono ${isBreakdown ? 'fill-danger' : 'fill-white'}`} style={{fontSize: '24px'}}>{availVal}%</text>
                            <text x="150" y="145" textAnchor="middle" className="fill-slate-500 text-[10px]">UPTIME</text>
                            <foreignObject x="138" y="45" width="24" height="24">
                                <i className={`ph-fill ph-engine text-2xl ${activeTab === 'Availability' ? 'text-accent' : 'text-slate-600'}`}></i>
                            </foreignObject>
                        </g>

                        <g onClick={() => onSelect('Performance')} className="group hover:opacity-90">
                             <rect x="330" y="70" width="140" height="100" rx="10" className={`fill-panel ${getNodeColor('Performance')}`} />
                            <text x="400" y="95" textAnchor="middle" className="fill-slate-400 text-xs font-bold font-mono tracking-widest">PERFORMANCE</text>
                            <text x="400" y="125" textAnchor="middle" className={`text-2xl font-bold font-mono ${isSlow ? 'fill-warn' : 'fill-white'}`} style={{fontSize: '24px'}}>{perfVal}</text>
                            <text x="400" y="145" textAnchor="middle" className="fill-slate-500 text-[10px]">BPM</text>
                             <foreignObject x="388" y="45" width="24" height="24">
                                <i className={`ph-fill ph-gauge text-2xl ${activeTab === 'Performance' ? 'text-accent' : 'text-slate-600'}`}></i>
                            </foreignObject>
                        </g>

                        <g onClick={() => onSelect('Quality')} className="group hover:opacity-90">
                             <rect x="580" y="70" width="140" height="100" rx="10" className={`fill-panel ${getNodeColor('Quality')}`} />
                            <text x="650" y="95" textAnchor="middle" className="fill-slate-400 text-xs font-bold font-mono tracking-widest">QUALITY</text>
                            <text x="650" y="125" textAnchor="middle" className={`text-2xl font-bold font-mono ${isScrap ? 'fill-danger' : 'fill-white'}`} style={{fontSize: '24px'}}>{rejectVal}%</text>
                            <text x="650" y="145" textAnchor="middle" className="fill-slate-500 text-[10px]">REJECTS</text>
                             <foreignObject x="638" y="45" width="24" height="24">
                                <i className={`ph-fill ph-eye text-2xl ${activeTab === 'Quality' ? 'text-accent' : 'text-slate-600'}`}></i>
                            </foreignObject>
                        </g>
                        
                        <rect 
                            x={activeTab === 'Availability' ? 80 : activeTab === 'Performance' ? 330 : 580} 
                            y="175" width="140" height="3" 
                            className="fill-accent transition-all duration-300" 
                        />
                    </svg>
                </div>
            );
        };

        const Lobby = ({ user, onCreate, onJoin }) => {
            const [name, setName] = useState("");
            const [code, setCode] = useState("");
            const [loading, setLoading] = useState(false);

            const handleCreate = async () => {
                setLoading(true);
                SoundFX.click();
                await onCreate(name);
                setLoading(false);
            };

            const handleJoin = async () => {
                setLoading(true);
                SoundFX.click();
                await onJoin(code, name);
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-bg tech-grid relative">
                    <div className="scada-panel p-0 w-full max-w-4xl z-10 animate-enter flex flex-col md:flex-row rounded-xl overflow-hidden shadow-2xl h-[500px]">
                        <div className="md:w-1/2 border-r border-slate-700 p-8 flex flex-col justify-center bg-panel">
                            <div className="mb-8">
                                <h1 className="text-4xl font-bold text-white mb-1 tracking-tight uppercase">Bottler's <span className="text-accent">Dilemma</span></h1>
                                <div className="text-slate-400 font-mono text-xs tracking-widest uppercase">OEE Optimization Simulation <br/> © Designed by Madhusudan Chhangani</div>
                            </div>
                            <div className="bg-black/30 p-5 rounded border border-slate-700 space-y-3 font-mono text-sm">
                                <div className="flex justify-between border-b border-slate-700 pb-2">
                                    <span className="text-slate-500">TARGET ASSET</span>
                                    <span className="text-white font-bold">LINE 1 LEGACY</span>
                                </div>
                                <div className="flex justify-between border-b border-slate-700 pb-2">
                                    <span className="text-slate-500">BASELINE OEE</span>
                                    <span className="text-danger font-bold">46.0%</span>
                                </div>
                                <div className="flex justify-between border-b border-slate-700 pb-2">
                                    <span className="text-slate-500">CAPEX BUDGET</span>
                                    <span className="text-white font-bold">$50,000</span>
                                </div>
                                <div className="grid grid-cols-3 gap-2 mt-4 text-center text-[10px] text-slate-400 pt-2">
                                    <div><div className="text-danger font-bold block">$150</div>/min Down</div>
                                    <div><div className="text-warn font-bold block">$2.50</div>/unit Scrap</div>
                                    <div><div className="text-success font-bold block">$0.30</div>/unit Margin</div>
                                </div>
                            </div>
                            <div className="text-center mt-6 text-xs text-slate-500 animate-pulse">
                                {loading ? "CONNECTING..." : "⚠ Best viewed in Full Screen Mode"}
                            </div>
                        </div>
                        <div className="md:w-1/2 p-8 flex flex-col justify-center space-y-6 bg-black/20">
                            <div>
                                <label className="text-xs text-accent font-bold ml-1 mb-2 block tracking-widest uppercase">Operator Name</label>
                                <input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full input-scada rounded p-4 font-bold text-lg" placeholder="ENTER NAME" />
                            </div>
                            <div className="space-y-3 pt-4">
                                <button onClick={handleCreate} disabled={!name || loading} className="w-full bg-accent hover:bg-white text-black font-bold py-4 rounded shadow-lg shadow-accent/20 transition-all disabled:opacity-50 flex items-center justify-center gap-2">
                                    START NEW GAME <i className="ph-bold ph-play-circle"></i>
                                </button>
                                <div className="flex gap-2 pt-4 border-t border-slate-700">
                                    <input type="text" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} className="flex-1 input-scada rounded p-3 text-center font-mono uppercase" placeholder="CODE" maxLength={4} />
                                    <button onClick={handleJoin} disabled={!name || code.length!==4 || loading} className="bg-slate-700 hover:bg-slate-600 border border-slate-600 text-white px-8 rounded font-bold transition-all disabled:opacity-50">JOIN</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const WaitingRoom = ({ roomCode, players, isHost, onStart }) => {
            const [duration, setDuration] = useState(20);
            return (
                 <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-bg tech-grid">
                    <div className="text-center mb-12 animate-enter">
                        <div className="text-accent text-sm font-bold tracking-widest uppercase mb-2 animate-pulse">Lobby Status</div>
                        <h2 className="text-8xl font-mono font-bold text-white tracking-tighter">{roomCode}</h2>
                        <div className="mt-6 inline-block px-6 py-2 rounded-full bg-panel border border-slate-700">
                            <span className="text-slate-400 font-mono text-sm">OPERATORS ONLINE: <span className="text-white font-bold text-lg ml-2">{players.length}</span></span>
                        </div>
                    </div>
                    
                    <div className="w-full max-w-3xl mb-12 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                            {players.map((p, i) => (
                                <div key={i} className="scada-panel p-4 flex items-center gap-3 animate-enter">
                                    <div className={`w-3 h-3 rounded-full ${p.isHost ? 'bg-accent shadow-[0_0_10px_cyan]' : 'bg-slate-500'}`}></div>
                                    <span className="font-mono text-white truncate">{p.name}</span>
                                    {p.isHost && <span className="ml-auto text-[10px] bg-accent text-black px-2 rounded font-bold">HOST</span>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {isHost ? (
                        <div className="flex flex-col items-center gap-6">
                            <div className="flex items-center gap-4 bg-panel p-2 rounded border border-slate-700">
                                <span className="text-xs font-bold text-slate-500 uppercase px-2">Duration:</span>
                                {[5, 10, 15, 20, 30].map(m => (
                                    <button 
                                        key={m} 
                                        onClick={() => { SoundFX.click(); setDuration(m); }}
                                        className={`px-3 py-1 rounded text-xs font-bold font-mono transition-all ${duration === m ? 'bg-accent text-black' : 'text-slate-400 hover:text-white'}`}
                                    >
                                        {m}m
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => { SoundFX.click(); SoundFX.start(); onStart(duration); }} className="bg-success hover:bg-white text-black font-bold py-4 px-12 rounded shadow-lg transition-all text-xl tracking-widest">
                                START SIMULATION
                            </button>
                        </div>
                    ) : <div className="text-slate-500 font-mono text-xs animate-pulse">...HOST IS CONFIGURING PARAMETERS...</div>}
                </div>
            );
        };

        const GameBoard = ({ endTime, startTime, onFinish }) => {
            const [timeLeft, setTimeLeft] = useState(0);
            const [activeTab, setActiveTab] = useState('Availability');
            const [cart, setCart] = useState([]);
            const stats = useMemo(() => calculateStats(cart), [cart]);

            useEffect(() => {
                const timer = setInterval(() => {
                    const remaining = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
                    setTimeLeft(remaining);
                    if (remaining === 180) SoundFX.urgency();
                    if (remaining === 0) onFinish(cart, (endTime - startTime)/1000);
                }, 1000);
                return () => clearInterval(timer);
            }, [endTime, cart, startTime]);

            const handleCommit = () => {
                const timeTaken = (Date.now() - startTime) / 1000;
                SoundFX.commit(); 
                onFinish(cart, timeTaken);
            }

            const toggleItem = (item) => {
                SoundFX.init();
                if (cart.includes(item.id)) {
                    setCart(p => p.filter(i => i !== item.id));
                    SoundFX.downgrade();
                } else {
                    if (stats.cost + item.cost > CASE.budget) return; 
                    setCart(p => [...p, item.id]);
                    SoundFX.upgrade();
                }
            };

            const formatMoney = n => n.toLocaleString('en-US', {style: 'currency', currency: 'USD', maximumFractionDigits:0});
            const items = UPGRADES.filter(u => u.cat === activeTab);

            const DashRow = ({ label, base, current, unit = '', color }) => (
                <div className="flex justify-between items-center py-2 border-b border-slate-800 text-sm">
                    <span className="text-slate-500 font-bold uppercase text-[10px] tracking-wider w-1/3">{label}</span>
                    <span className="text-slate-600 font-mono text-xs w-1/3 text-right">{base}{unit}</span>
                    <span className={`font-mono font-bold text-base w-1/3 text-right ${color || 'text-white'}`}>{current}{unit}</span>
                </div>
            );

            return (
                <div className="h-screen flex flex-col bg-bg text-slate-200 overflow-hidden font-sans">
                    <header className="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-panel z-20 shadow-lg">
                        <div className="flex items-center gap-4">
                            <div className="w-8 h-8 bg-accent text-black flex items-center justify-center font-bold rounded"><i className="ph-bold ph-factory"></i></div>
                            <div>
                                <div className="font-bold text-white leading-none text-lg uppercase tracking-tight">Bottler's Dilemma</div>
                                <div className="text-[10px] text-slate-500 font-mono">OEE Optimization Simulation © Designed by Madhusudan Chhangani</div>
                            </div>
                        </div>
                        <div className={`font-mono text-3xl font-bold ${timeLeft < 180 ? 'text-danger animate-pulse' : 'text-white'}`}>
                            {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        <main className="flex-1 overflow-y-auto p-6 relative tech-grid">
                            <div className="max-w-7xl mx-auto">
                                <FactorySchematic stats={stats.stats} cart={cart} activeTab={activeTab} onSelect={setActiveTab} />
                                <div className="flex gap-1 mb-6 border-b border-slate-700">
                                    {['Availability', 'Performance', 'Quality'].map(cat => (
                                        <button key={cat} onClick={() => { SoundFX.click(); setActiveTab(cat); }} className={`px-8 py-3 text-sm font-bold uppercase tracking-widest nav-btn ${activeTab === cat ? 'active text-accent border-b-2 border-accent bg-accent/5' : 'text-slate-500 hover:text-white'}`}>
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 pb-20 animate-enter">
                                    {items.map(item => {
                                        const isSel = cart.includes(item.id);
                                        const isAffordable = stats.cost + item.cost <= CASE.budget;
                                        return (
                                            <div key={item.id} onClick={() => (isSel || isAffordable) && toggleItem(item)} className={`tech-card p-4 rounded cursor-pointer transition-all group relative hover:-translate-y-1 ${isSel ? 'active' : ''} ${!isSel && !isAffordable ? 'opacity-40 grayscale' : ''}`}>
                                                <div className="flex justify-between items-start mb-3">
                                                    <i className={`ph-fill ${item.icon} text-2xl ${isSel ? 'text-accent' : 'text-slate-600 group-hover:text-white'}`}></i>
                                                    <div className={`font-mono font-bold ${isSel ? 'text-white' : 'text-slate-400'}`}>{formatMoney(item.cost)}</div>
                                                </div>
                                                <h4 className="font-bold text-white mb-1 leading-tight">{item.name}</h4>
                                                <p className="text-[11px] text-slate-400 leading-relaxed h-8 overflow-hidden">{item.desc}</p>
                                                {isSel && <div className="absolute top-2 right-2 w-2 h-2 bg-accent rounded-full shadow-[0_0_10px_#38bdf8]"></div>}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </main>

                        <aside className="w-96 bg-panel border-l border-slate-800 flex flex-col z-20 shadow-2xl relative sidebar-grid">
                            <div className="p-5 border-b border-slate-800 bg-slate-900/30">
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i className="ph-fill ph-info"></i> CASE FACTS</h3>
                                <div className="space-y-2 font-mono text-xs text-slate-400">
                                    <div className="flex justify-between"><span>Baseline OEE</span> <span className="text-danger font-bold">46.0%</span></div>
                                    <div className="flex justify-between"><span>Budget</span> <span className="text-white">$50,000</span></div>
                                </div>
                            </div>

                            <div className="p-5 flex-1 flex flex-col bg-[#08090C] sidebar-content overflow-y-auto min-h-0">
                                <h3 className="text-xs font-bold text-accent uppercase tracking-widest mb-4">LIVE PERFORMANCE</h3>
                                <div className="bg-black/30 rounded p-3 border border-slate-700 mb-4 text-center">
                                    <div className="text-[10px] text-slate-500 uppercase font-bold">Projected OEE</div>
                                    <div className="text-4xl font-mono font-bold text-white">{(stats.oee*100).toFixed(1)}%</div>
                                </div>
                                <div className="space-y-0">
                                    <DashRow label="Availability" base="75.0" current={((stats.availPct)*100).toFixed(1)} unit="%" color="text-accent" />
                                    <DashRow label="Performance" base="66.7" current={((stats.perfPct)*100).toFixed(1)} unit="%" color="text-accent" />
                                    <DashRow label="Quality" base="92.0" current={((stats.qualPct)*100).toFixed(1)} unit="%" color="text-accent" />
                                    <DashRow label="Quality Output" base={Math.floor(stats.baseProd).toLocaleString()} current={Math.floor(stats.totalProd).toLocaleString()} />
                                    <DashRow label="Profit" base={formatMoney(stats.baseProfit)} current={formatMoney(stats.profit)} color="text-success" />
                                    <div className="flex justify-between items-center py-3 mt-2 border-t border-slate-800">
                                        <span className="text-accent font-bold">ROI</span>
                                        <span className="text-2xl font-mono font-bold text-white">{stats.roi.toFixed(0)}%</span>
                                    </div>
                                </div>
                            </div>

                            <div className="p-5 border-t border-slate-800 bg-[#0b0e14] sidebar-footer">
                                <div className="mb-3">
                                    <div className="flex justify-between text-xs mb-1 font-bold text-slate-400">
                                        <span>BUDGET</span>
                                        <span className={stats.cost > CASE.budget ? "text-danger" : "text-white"}>{formatMoney(stats.cost)}</span>
                                    </div>
                                    <div className="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                                        <div className={`h-full transition-all duration-500 ${stats.cost > CASE.budget ? 'bg-danger' : 'bg-accent'}`} style={{width: `${Math.min((stats.cost/CASE.budget)*100, 100)}%`}}></div>
                                    </div>
                                </div>
                                <button onClick={handleCommit} disabled={stats.cost > CASE.budget} className="w-full bg-success hover:bg-white text-black font-bold py-3 rounded shadow-lg transition-all disabled:opacity-50 disabled:bg-slate-800 disabled:text-slate-500">
                                    {stats.cost > CASE.budget ? 'OVER BUDGET' : 'COMMIT STRATEGY'}
                                </button>
                            </div>
                        </aside>
                    </div>
                </div>
            );
        };

        const Leaderboard = ({ roomCode, players, onExit }) => {
            const [details, setDetails] = useState(null);
            
            const sorted = [...players].sort((a, b) => {
                const profitA = a.score?.profit || 0;
                const profitB = b.score?.profit || 0;
                if (Math.abs(profitA - profitB) > 1) return profitB - profitA;
                
                const timeA = a.score?.timeTaken || 999999;
                const timeB = b.score?.timeTaken || 999999;
                return timeA - timeB;
            });

            // Calculate submitted counts
            const submittedCount = players.filter(p => p.score).length;
            const totalCount = players.length;

            const optimal = useMemo(() => solveOptimal(), []);

            useEffect(() => SoundFX.win(), []);

            const formatTime = (s) => {
                if(!s) return "--:--";
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}m ${sec}s`;
            };

            const renderDetails = (player) => {
                const s = player.score;
                return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={() => setDetails(null)}>
                        <div className="tech-card p-8 max-w-4xl w-full rounded-xl bg-[#0F1115]" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between mb-6 border-b border-slate-800 pb-4">
                                <h2 className="text-3xl font-bold text-white">Strategy Audit: <span className="text-accent">{player.name}</span></h2>
                                <button onClick={() => setDetails(null)}><i className="ph-bold ph-x text-slate-500 hover:text-white text-2xl"></i></button>
                            </div>
                            <div className="grid grid-cols-3 gap-4 mb-6 font-mono">
                                <div className="p-3 bg-slate-900 rounded border border-slate-700 text-center">
                                    <div className="text-[10px] text-slate-500 uppercase">Investment</div>
                                    <div className="text-xl text-white">${s.cost.toLocaleString()}</div>
                                </div>
                                <div className="p-3 bg-slate-900 rounded border border-slate-700 text-center">
                                    <div className="text-[10px] text-slate-500 uppercase">Profit</div>
                                    <div className="text-xl text-success">${s.profit.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                                </div>
                                <div className="p-3 bg-slate-900 rounded border border-slate-700 text-center">
                                    <div className="text-[10px] text-slate-500 uppercase">Time</div>
                                    <div className="text-xl text-accent">{formatTime(s.timeTaken)}</div>
                                </div>
                            </div>
                            <h4 className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-widest">Line Items</h4>
                            <div className="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto custom-scrollbar">
                                {s.cart.map(id => {
                                    const u = UPGRADES.find(x => x.id === id);
                                    return (
                                        <div key={id} className="flex justify-between p-2 bg-slate-800/50 rounded border-l-2 border-slate-600 text-xs text-slate-300">
                                            <span>{u.name}</span>
                                            <span className="font-mono">${u.cost.toLocaleString()}</span>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                )
            };

            return (
                <div className="min-h-screen bg-[#050505] p-8 flex flex-col items-center tech-grid">
                    {details && renderDetails(details)}
                    <div className="max-w-6xl w-full animate-enter">
                        <div className="flex justify-between items-end mb-8 border-b border-slate-800 pb-6">
                            <div>
                                <h1 className="text-5xl font-bold text-white tracking-tight uppercase">Leaderboard</h1>
                                <div className="text-accent font-mono">
                                    ROOM: {roomCode}
                                    <span className="ml-4 text-slate-500 text-sm">[{submittedCount}/{totalCount} SUBMITTED]</span>
                                </div>
                            </div>
                            <button onClick={onExit} className="text-slate-400 hover:text-white uppercase text-sm font-bold tracking-widest">Exit to Lobby</button>
                        </div>
                        <div className="mb-8 p-1 bg-gradient-to-r from-accent/20 to-transparent rounded border border-accent/30">
                            <div className="bg-[#0A0C10] p-4 flex justify-between items-center">
                                <div>
                                    <div className="text-xs font-bold text-accent uppercase tracking-widest">AI Optimal Strategy</div>
                                    <div className="text-white">Target Profit: <span className="font-mono text-success font-bold">${optimal.profit.toLocaleString(undefined,{maximumFractionDigits:0})}</span></div>
                                </div>
                                <button onClick={() => setDetails({name: "AI Solver", score: optimal})} className="px-4 py-2 border border-slate-600 hover:border-white text-xs font-bold text-white uppercase transition-all">VIEW STRATEGY</button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-12 p-2 mb-2 text-xs font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800">
                            <div className="col-span-1">Rank</div>
                            <div className="col-span-3">Operator</div>
                            <div className="col-span-2 text-right">OEE</div>
                            <div className="col-span-2 text-right">Profit</div>
                            <div className="col-span-2 text-right">ROI</div>
                            <div className="col-span-1 text-right">Time</div>
                            <div className="col-span-1 text-right">View</div>
                        </div>

                        <div className="space-y-2 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
                            {sorted.map((p, i) => (
                                <div key={i} className={`scada-panel p-4 rounded grid grid-cols-12 items-center transition-all hover:bg-slate-800 ${i===0 ? 'border-l-4 border-l-warn' : ''}`}>
                                    <div className="col-span-1 font-mono text-slate-500">#{i+1}</div>
                                    <div className="col-span-3 font-bold text-white flex items-center gap-2 truncate">
                                        {p.name}
                                        {i===0 && <i className="ph-fill ph-crown text-warn"></i>}
                                    </div>
                                    <div className="col-span-2 text-right font-mono text-white">{(p.score?.oee * 100).toFixed(1)}%</div>
                                    <div className="col-span-2 text-right font-mono text-success">${p.score?.profit.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                                    <div className="col-span-2 text-right font-mono text-accent">{p.score?.roi.toFixed(0)}%</div>
                                    <div className="col-span-1 text-right font-mono text-slate-400">{formatTime(p.score?.timeTaken)}</div>
                                    <div className="col-span-1 text-right">
                                        <button onClick={() => setDetails(p)} className="text-xs font-bold text-slate-400 hover:text-white underline decoration-slate-700 underline-offset-4">VIEW</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lobby'); 
            const [roomCode, setRoomCode] = useState(null);
            const [players, setPlayers] = useState([]);
            const [endTime, setEndTime] = useState(null);
            const [startTime, setStartTime] = useState(null);
            const [isHost, setIsHost] = useState(false);
            const [error, setError] = useState(null);

            // Initialize User on Mount
            useEffect(() => {
                if (USE_FIREBASE && firebaseConfig.apiKey === "YOUR_API_KEY") {
                    setError("SETUP ERROR: You enabled Firebase but didn't paste your API Keys in the code.");
                    return;
                }

                Backend.signIn()
                    .then(u => setUser(u))
                    .catch(e => {
                        console.error("Auth failed:", e);
                        // Show exact error code for better debugging
                        let msg = "Authenticating failed.";
                        if (e.code === 'auth/operation-not-allowed') msg += " (Enable Anonymous Auth in Firebase Console)";
                        else if (e.code === 'auth/invalid-api-key') msg += " (Invalid API Key)";
                        else if (e.code === 'auth/project-not-found') msg += " (Project not found)";
                        else msg += " " + e.message;
                        
                        setError(msg);
                    });
            }, []);

            // Room Subscription
            useEffect(() => {
                if (!roomCode) return;
                
                const unsubscribe = Backend.subscribe(roomCode, (roomData) => {
                    if (!roomData) return;
                    
                    setPlayers(roomData.players || []);
                    setEndTime(roomData.endTime);
                    setStartTime(roomData.startTime);
                    
                    if (roomData.status === 'playing' && view === 'waiting') setView('game');
                    if (roomData.status === 'finished' && view === 'game') setView('results');
                    
                    if (user) {
                        const me = roomData.players.find(p => p.uid === user.uid);
                        if (me && me.isHost) setIsHost(true);
                    }
                });

                return () => unsubscribe && unsubscribe();
            }, [roomCode, view, user]);

            const handleCreate = async (name) => {
                try {
                    const code = await Backend.createRoom(name, user.uid);
                    setRoomCode(code);
                    setIsHost(true);
                    setView('waiting');
                } catch (e) {
                    console.error(e);
                    alert("Error creating room");
                }
            };

            const handleJoin = async (code, name) => {
                try {
                    await Backend.joinRoom(code, name, user.uid);
                    setRoomCode(code);
                    setView('waiting');
                } catch (e) {
                    console.error(e);
                    alert("Error joining room: " + e.message);
                }
            };

            const handleStart = async (duration) => {
                try {
                    const start = Date.now();
                    const end = start + (duration * 60 * 1000);
                    await Backend.updateRoom(roomCode, {
                        status: 'playing',
                        startTime: start,
                        endTime: end
                    });
                } catch (e) {
                    console.error("Start failed", e);
                }
            };

            const handleFinish = async (cart, timeTaken) => {
                const res = calculateStats(cart); 
                res.cart = cart;
                res.timeTaken = timeTaken;
                
                try {
                    if (Backend.submitScore) {
                        await Backend.submitScore(roomCode, user.uid, res);
                    } else {
                        // Fallback for MockAPI
                        const updatedPlayers = players.map(p => {
                            if (p.uid === user.uid) return { ...p, score: res };
                            return p;
                        });
                        const allFinished = updatedPlayers.every(p => p.score);
                        const updateData = { players: updatedPlayers };
                        if (allFinished) updateData.status = 'finished';
                        await Backend.updateRoom(roomCode, updateData);
                    }
                    setView('results');
                } catch (e) {
                    console.error("Finish failed", e);
                }
            };

            if (error) return <div className="min-h-screen bg-black flex items-center justify-center text-danger font-mono text-center p-4"><div className="border border-danger p-4 rounded bg-danger/10"><div className="font-bold text-xl mb-2">⚠ ERROR</div>{error}</div></div>;

            if (!user) return <div className="min-h-screen bg-black flex items-center justify-center text-accent font-mono animate-pulse">INITIALIZING UPLINK...</div>;

            return (
                <React.Fragment>
                    {view === 'lobby' && <Lobby user={user} onCreate={handleCreate} onJoin={handleJoin} />}
                    {view === 'waiting' && <WaitingRoom roomCode={roomCode} players={players} isHost={isHost} onStart={handleStart} />}
                    {view === 'game' && <GameBoard endTime={endTime} startTime={startTime} onFinish={handleFinish} />}
                    {view === 'results' && <Leaderboard roomCode={roomCode} players={players} onExit={() => setView('lobby')} />}
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
